# -*- coding: utf-8 -*-
"""agente-luis-travel.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1lFczHlkvl3HdGmrOue5nPOp-QAhqNRr9
"""

# Commented out IPython magic to ensure Python compatibility.
# %pip -q install google-adk
# %pip -q install google-genai

import os
import re
import urllib.parse
import warnings
from datetime import datetime

try:
    from google.colab import userdata
    os.environ["GOOGLE_API_KEY"] = userdata.get("GOOGLE_API_KEY")
except ModuleNotFoundError:
    pass

from google.adk.agents import Agent
from google.adk.runners import Runner
from google.adk.sessions import InMemorySessionService
from google.adk.tools import google_search
from google.genai import types

from IPython.display import display, Markdown, HTML

warnings.filterwarnings("ignore")

def call_agent(agent: Agent, message_text: str) -> str:
    session_service = InMemorySessionService()
    session_service.create_session(app_name=agent.name, user_id="user1", session_id="session1")
    runner = Runner(agent=agent, app_name=agent.name, session_service=session_service)

    content = types.Content(role="user", parts=[types.Part(text=message_text)])
    final_response = ""
    for event in runner.run(user_id="user1", session_id="session1", new_message=content):
        if event.is_final_response():
            for part in event.content.parts:
                if part.text is not None:
                    final_response += part.text + "\n"
    return final_response.strip()


def maps_link(place: str, city: str) -> str:
    base = "https://www.google.com/maps/search/?api=1&query="
    return base + urllib.parse.quote_plus(f"{place} {city}")


def add_maps_links(markdown_text: str, city: str) -> str:
    def repl(match: re.Match) -> str:
        attraction = match.group(1).strip()
        url = maps_link(attraction, city)
        return f"- [{attraction}]({url})"
    pattern = r"^[\-\*]\s+(.+?)(?:\n|$)"
    return re.sub(pattern, repl, markdown_text, flags=re.MULTILINE)


def colapsar_por_dia(markdown_text: str) -> str:
    blocos = markdown_text.split("### Dia")
    html = ""
    for bloco in blocos[1:]:
        linhas = bloco.split("\n")
        dia_titulo = linhas[0].strip()
        corpo = "\n".join(linhas[1:]).strip()
        # Split the body by '-' and join with newline to force line breaks
        corpo_com_quebras = "\n".join(corpo.split('-'))
        html += (
            f"<details style='margin-bottom:0.8em'>"
            f"<summary style='font-weight:bold;font-size:1.1em'>Dia {dia_titulo}</summary>"
            # Use the modified corpo_com_quebras with line breaks
            f"<pre style='white-space:pre-wrap'>{corpo_com_quebras}</pre></details>"
        )
    return html

def agente_buscador(destino: str, data_de_hoje: str) -> str:
    agent = Agent(
        name="agente_buscador",
        model="gemini-2.0-flash",
        instruction="""
        Encontre atÃ© 5 roteiros de viagem recentes (atÃ© 1 mÃªs) sobre o destino fornecido.
        Use fontes confiÃ¡veis e mostre sugestÃµes com programaÃ§Ã£o diÃ¡ria e dicas prÃ¡ticas.
        """,
        description="Busca roteiros recentes",
        tools=[google_search],
    )
    entrada = f"Destino: {destino}\nData atual: {data_de_hoje}"
    return call_agent(agent, entrada)


def agente_planejador(destino: str, preferencias: str, roteiro_base: str, pontos_desejados: str) -> str:
    agent = Agent(
        name="agente_planejador",
        model="gemini-2.0-flash",
        instruction="""
        Gere um plano de viagem personalizado com base nas preferÃªncias, pontos turÃ­sticos desejados e estilo de viagem.
        Use tambÃ©m os roteiros de referÃªncia encontrados.
        """,
        description="Planejador de viagem",
        tools=[google_search],
    )
    entrada = f"Destino: {destino}\nPreferÃªncias: {preferencias}\nPontos desejados: {pontos_desejados}\nBase: {roteiro_base}"
    return call_agent(agent, entrada)


def agente_documentos(destino: str, cidade_origem: str) -> str:
    agent = Agent(
        name="agente_documentos",
        model="gemini-2.0-flash",
        instruction="""
        Liste os documentos necessÃ¡rios para uma viagem internacional entre a cidade de origem e o destino.
        Inclua passaporte, visto, vacinas etc. Utilize busca em fontes confiÃ¡veis, Seja direto, sem muito texto.
        """,
        description="DocumentaÃ§Ã£o necessÃ¡ria",
        tools=[google_search],
    )
    entrada = f"Origem: {cidade_origem}\nDestino: {destino}"
    return call_agent(agent, entrada)


def agente_voo(destino: str, cidade_origem: str, data_ida: str, data_volta: str) -> str:
    agent = Agent(
        name="agente_voo",
        model="gemini-2.0-flash",
        instruction="""
        Pesquise o menor valor de passagens de ida e volta para o destino informado.
        Inclua a companhia aÃ©rea e horÃ¡rios aproximados. Use busca atual. Seja simples e direto, deixe a leitura
        boa e use emoji para topicos.
        """,
        description="Busca de passagens aÃ©reas",
        tools=[google_search],
    )
    entrada = f"Origem: {cidade_origem}\nDestino: {destino}\nIda: {data_ida}\nVolta: {data_volta}"
    return call_agent(agent, entrada)


def agente_acomodacao(destino: str, data_ida: str, data_volta: str, orcamento_float: float) -> str:
    agent = Agent(
        name="agente_acomodacao",
        model="gemini-2.0-flash",
        instruction="""
        Sugira 3 hospedagens (hotel ou hostel ou Airbnb) para o destino e datas informadas, com valor atÃ© 40% do orÃ§amento diÃ¡rio.
        Mostre nome, tipo, localizaÃ§Ã£o, preÃ§o por noite e link, Seja simples e sucinto.
        """,
        description="SugestÃµes de hospedagem",
        tools=[google_search],
    )
    entrada = f"Destino: {destino}\nData ida: {data_ida}\nData volta: {data_volta}\nOrÃ§amento diÃ¡rio: {orcamento_float}"
    return call_agent(agent, entrada)


def obter_previsao_media(destino: str, data_inicio: str, data_fim: str) -> str:
    agent = Agent(
        name="agente_clima",
        model="gemini-2.0-flash",
        instruction="""
        Mostre o clima mÃ©dio entre as datas da viagem. Se for internacional, inclua cotaÃ§Ã£o da moeda local em reais.
        Use emojis e uma apresentaÃ§Ã£o amigÃ¡vel. Seja sucinto e simples
        """,
        description="Clima e cÃ¢mbio",
        tools=[google_search],
    )
    entrada = f"Destino: {destino}\nData inÃ­cio: {data_inicio}\nData fim: {data_fim}"
    return call_agent(agent, entrada)


def agente_estruturador(destino: str, roteiro_bruto: str) -> str:
    agent = Agent(
        name="agente_estruturador",
        model="gemini-2.0-flash",
        instruction="""
        Estruture o roteiro em sessÃµes por dia (### Dia 1, Dia 2...).
        Use bullets com emoji, nome da atraÃ§Ã£o e horÃ¡rio estimado.
        NÃ£o inclua URLs; elas serÃ£o adicionadas por pÃ³s-processamento.
        Mostre o custo total e uma dica no final.
        """,
        description="Organizador de roteiro final",
    )
    entrada = f"Destino: {destino}\nRoteiro: {roteiro_bruto}"
    return call_agent(agent, entrada)



# InÃ­cio
print(r"""
             __|__
--@--@--@--@--(_)--@--@--@--@--

     âœˆï¸  Bem-vindo Ã  Luis Travel âœˆï¸
     Seu roteiro comeÃ§a aqui. ğŸŒ
""")


print("âœˆï¸ Chega de perder horas pesquisando atraÃ§Ãµes, clima e hospedagem por conta prÃ³pria!")
print("âœ¨ Com apenas algumas perguntas, eu preparo o roteiro perfeito pra sua viagem \nrÃ¡pido, personalizado e do jeitinho que vocÃª gosta.\n")
print("ğŸ“‹ Vamos comeÃ§ar? Me diga para onde vocÃª vai e eu cuido do resto. ğŸ˜„")


cidade_origem = input("ğŸ  Cidade de origem: ")
destino = input("ğŸ“ Para qual cidade vocÃª vai viajar? ")
data_ida = input("ğŸ›« Data de ida? (dd/mm/aaaa): ")
data_volta = input("ğŸ›¬ Data de volta? (dd/mm/aaaa): ")
estilo = input("ğŸ§³ Estilo (econÃ´mico, conforto, aventura): ").lower()
orcamento = input("ğŸ’° OrÃ§amento diÃ¡rio (R$): ")
lazer = input("ğŸ­ Incluir shows/cultura local? (sim/nÃ£o): ").lower()
pontos_turisticos = input("ğŸ“Œ Pontos turÃ­sticos especÃ­ficos (vÃ­rgula) ou 'nÃ£o': ")

try:
    orcamento_float = float(orcamento.replace(",", "."))
except ValueError:
    orcamento_float = 100.0

preferencias = (
    f"Ida: {data_ida}, Volta: {data_volta}, Estilo: {estilo}, "
    f"OrÃ§amento: R${orcamento}/dia, Lazer: {lazer}."
)

print("\nğŸ”† PrevisÃ£o do clima e cÃ¢mbio...")
clima = obter_previsao_media(destino, data_ida, data_volta)
display(Markdown(clima))

print("\nâœˆï¸ Cotando preÃ§o da passagem aÃ©rea...")
voo = agente_voo(destino, cidade_origem, data_ida, data_volta)
display(Markdown(voo))

print("\nğŸ¨ Sugerindo hospedagens econÃ´micas...")
acomodacoes = agente_acomodacao(destino, data_ida, data_volta, orcamento_float)
display(Markdown(acomodacoes))

print("\nğŸ“„ DocumentaÃ§Ã£o necessÃ¡ria...")
docs = agente_documentos(destino, cidade_origem)
display(Markdown(docs))

data_hoje = datetime.today().strftime("%d/%m/%Y")
base_roteiro = agente_buscador(destino, data_hoje)

print("\nğŸ§­ Gerando roteiro personalizado...")
roteiro_planejado = agente_planejador(destino, preferencias, base_roteiro, pontos_turisticos)

roteiro_formatado = agente_estruturador(destino, roteiro_planejado)
roteiro_com_links = add_maps_links(roteiro_formatado, destino)

display(Markdown("\n## ğŸ“… Roteiro final da viagem"))
display(Markdown(roteiro_com_links))

print("\nğŸ‰ Pronto! Seu roteiro estÃ¡ no ponto. Agora Ã© sÃ³ embarcar nessa viagem incrÃ­vel! âœˆï¸ğŸŒ")